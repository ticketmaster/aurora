branches:
  only:
    - gh-pages
    - /.*/
cache:
  directories:
    - node_modules
dist: xenial
jobs:
  include:
    - stage: lint
      script:
        - npm run lint
        - npm run lint:css
    - stage: test branch
      script:
        - git fetch --no-tags --depth=1 origin master
        - git checkout -b master
        - git checkout $GITHUB_REF
        - npm run test:ci
      if: branch != master
    - stage: test master
      script:
        - npm run test:ci
      if: branch = master
    - stage: build
      cleanup: false
      script:
        - npm run build
        - npm run catalog-build
        - npx codecov
    - stage: deploy
      deploy:
        - provider: script
          cleanup: false
          script: npx semantic-release
        - provider: pages
          cleanup: false
          keep_history: true
          local_dir: catalog/build
          target_branch: gh-pages
          token: $GITHUB_TOKEN
          strategy: git
      script: skip
language: node_js
os: linux
notifications:
  email: false
stages:
  - name: lint
  - name: test branch
  - name: test master
  - name: build
  - name: deploy
    if: branch = master AND type != pull_request
